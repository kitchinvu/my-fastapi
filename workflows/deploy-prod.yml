name: Auto Deploy to Production

on:
  push:
    branches: [ main ]
  # Manual trigger option
  workflow_dispatch:

jobs:
  deploy-prod:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://${{ secrets.PROD_SERVER_HOST }}:8000

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "ðŸš€ Starting deployment to Production Server..."

            # Navigate to project directory
            cd /app/admin-portal

            # Backup database before deployment (IMPORTANT!)
            echo "ðŸ“¦ Backing up database..."
            cd backend
            timestamp=$(date +%Y%m%d_%H%M%S)
            docker compose exec -T mysql mysqldump -u fastapi_user -pfastapi_password user_management > /app/backups/db_backup_${timestamp}.sql 2>/dev/null || echo "âš ï¸  Database backup failed or not available"

            # Return to project root
            cd /app/admin-portal

            # Stash any local changes
            git stash

            # Pull latest code from main branch
            echo "ðŸ“¥ Pulling latest code from main branch..."
            git fetch origin main
            git checkout main
            git pull origin main

            # Navigate to backend folder
            cd backend

            # Check if .env exists
            if [ ! -f .env ]; then
              echo "âš ï¸  .env file not found! Copying from .env.example..."
              cp .env.example .env
              echo "âš ï¸  CRITICAL: Please update .env file with production values!"
              exit 1
            fi

            # Rebuild and restart containers
            echo "ðŸ”„ Rebuilding and restarting Docker containers..."
            docker compose down
            docker compose up -d --build

            # Wait for services to be ready
            echo "â³ Waiting for services to start..."
            sleep 20

            # Check container status
            echo "ðŸ“Š Container Status:"
            docker compose ps

            # Health check with retries
            echo "ðŸ¥ Running health check..."
            success=false
            for i in {1..15}; do
              if curl -f http://localhost:8000/health; then
                echo ""
                echo "âœ… Health check passed!"
                success=true
                break
              fi
              echo "Attempt $i/15 - waiting..."
              sleep 3
            done

            # If health check fails, show logs and exit
            if [ "$success" = false ]; then
              echo "âŒ Health check failed after 15 attempts!"
              echo "ðŸ“‹ Container logs:"
              docker compose logs --tail=50
              exit 1
            fi

            # Show recent logs
            echo "ðŸ“‹ Recent logs:"
            docker compose logs --tail=20 fastapi

            # Clean up old backups (keep last 7 days)
            echo "ðŸ§¹ Cleaning up old backups..."
            find /app/backups -name "db_backup_*.sql" -mtime +7 -delete 2>/dev/null || true

            echo "âœ… Deployment to Production Server completed successfully!"

      - name: Deployment Summary
        if: success()
        run: |
          echo "### âœ… Production Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** http://${{ secrets.PROD_SERVER_HOST }}:8000" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note:** Database backup was created before deployment" >> $GITHUB_STEP_SUMMARY

      - name: Deployment Failed
        if: failure()
        run: |
          echo "### âŒ Production Deployment Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CRITICAL:** Production deployment failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
          echo "1. SSH into production server immediately" >> $GITHUB_STEP_SUMMARY
          echo "2. Check container logs: \`docker compose logs\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify database backup is available" >> $GITHUB_STEP_SUMMARY
          echo "4. Consider rollback if necessary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ secrets.PROD_SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
